<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.advu.workflow.dao.database.SysPermissionMapper">

    <resultMap id="permissionResultMap" type="cn.advu.workflow.domain.database.SysPermission">
        <id column="permission_id" jdbcType="INTEGER" property="permissionId"/>
        <result column="permission_name" jdbcType="VARCHAR"  property="permissionName"/>
        <result column="cmt" jdbcType="VARCHAR" property="cmt"/>
        <result column="menu_name" jdbcType="VARCHAR" property="menuName"/>
        <result column="menu_uri" jdbcType="VARCHAR" property="menuUri"/>
        <result column="permission_status" jdbcType="TINYINT" property="permissionStatus"/>
        <result column="belong_to" jdbcType="TINYINT" property="belongTo"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
    </resultMap>

    <insert id="add">
		INSERT INTO sys_permission (
		    permission_name,
		    permission_status,
		    menu_uri,
		    menu_name,
		    belong_to,
		    cmt,
		    create_time
		)
		VALUES (
		    #{permission.permissionName}, 
		    #{permission.permissionStatus}, 
		    #{permission.menuUri}, 
		    #{permission.menuName}, 
		    #{permission.belongTo}, 
		    #{permission.cmt}, 
		    NOW()
		)
    </insert>
    
    <select id="getByRoleId" resultMap="permissionResultMap">
		SELECT
		    p.*
		FROM
		    sys_permission p
		JOIN sys_role_permission rp ON p.permission_id = rp.permission_id
		JOIN sys_role r ON rp.role_id = r.role_id
		WHERE
		    r.role_id = #{roleId}    
    </select>
    
    <insert id="addPermissionForRole">
		INSERT INTO sys_role_permission (
		    creator_id,
		    role_id,
		    permission_id,
		    create_time
		)
		VALUES
		    (#{creatorId}, #{roleId}, #{pid}, NOw())    
    </insert>
    
    <select id="getAll" resultMap="permissionResultMap">
        SELECT * FROM sys_permission WHERE permission_status = 0    
    </select>
    
    <select id="getByUserId" resultMap="permissionResultMap">
		SELECT
		    p.*
		FROM
		    sys_user u
		JOIN sys_user_role ur ON u.user_id = ur.user_id
		JOIN sys_role_permission rp ON ur.role_id = rp.role_id
		JOIN sys_permission p ON rp.permission_id = p.permission_id
		WHERE
		    u.user_id = #{userId}    
    </select>    
</mapper>
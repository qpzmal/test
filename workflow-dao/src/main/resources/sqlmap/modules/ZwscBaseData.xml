<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.advu.workflow.dao.database.ZwscBaseDataMapper">

    <sql id="conditions">
		<where>
			and b.apptype = '1'
            <if test="startTime != '' and startTime != null">
                AND b.dt &gt;= #{startTime}
            </if>

            <if test="endTime != '' and endTime != null">
                AND b.dt &lt;= #{endTime}
            </if>
            <if test="cnids != null and cnids != ''">
                AND b.cnid IN
                <foreach collection="cnids" item="cnid" open="(" separator="," close=")">
                    ${cnid}
                </foreach>
            </if>
		</where>
    </sql>

    <select id="getVersions" resultType="String">
		SELECT DISTINCT
		    version
		FROM
		    zwsc_base_data
		WHERE version IS NOT NULL        
    </select>
    
    <select id="getItemCnt" resultType="int">
		SELECT COUNT(1) FROM
		(
			SELECT b.dt
			FROM zwsc_base_data b
			<include refid="conditions"></include>
			GROUP BY b.cnid
		) t
    </select>
    
    <select id="getDetailByPage" resultType="Map">
		SELECT
			b.cnid,
			IFNULL(SUM(b.accumulate_user), 0) AS accumUsers,
			IFNULL(SUM(b.qd_uv), 0) AS qdUsers,
			IFNULL(SUM(b.new_user), 0) AS newUsers,
			IFNULL(SUM(b.qd_pv), 0) AS qdTimes,
			IFNULL(ROUND(SUM(b.charge_money) /100,2), 0) AS chargeMoney,
			IFNULL(SUM(b.charge_user), 0) AS chargeUsers,
			IFNULL(SUM(b.consumer_user), 0) AS consumeUsers,
			IFNULL(SUM(b.consumer_cash), 0) AS vouchers,
			IFNULL(SUM(b.consumer_unitmoney), 0) AS realMoney,
			IFNULL(SUM(b.consumer_unitvirtual), 0) AS copperCoin,
			IFNULL(SUM(b.book_num), 0) AS bookNum,
			IFNULL(SUM(b.chapter_pv), 0) AS chapterNum,
			IFNULL(ROUND(a.qd_remain / SUM(b.qd_uv) * 100,2), 0) AS qdRemain,
			IFNULL(ROUND(a.add_remain / SUM(b.new_user) * 100,2), 0) AS addRemain,
			IFNULL(SUM(b.consumer_money_user), 0) AS consumerMoneyUser
		FROM
		zwsc_base_data b left join
		(
			select SUM(qd_remain) qd_remain,SUM(add_remain) add_remain,cnid
			from qd_add_remain where appname = 'zwsc'
			<if test="startTime != '' and startTime != null">
				AND dt &gt;= #{startTime}
			</if>
			<if test="endTime != '' and endTime != null">
				AND dt &lt;= #{endTime}
			</if>
			<if test="cnids != null and cnids != ''">
				AND cnid IN
				<foreach collection="cnids" item="cnid" open="(" separator="," close=")">
					${cnid}
				</foreach>
			</if>
			GROUP BY cnid
		) a on a.cnid = b.cnid
		<include refid="conditions"></include>
		GROUP BY b.cnid
		<if test="pageSize != 0">
			LIMIT #{startRow}, #{pageSize}
		</if>

    </select>
    

	<select id="getChannelUserDataByDay" resultType="Map">
		SELECT
		dt AS timeCycle,
		IFNULL(SUM(qd_uv), 0) AS qdUsers,
		IFNULL(SUM(new_user), 0) AS newUsers,
		IFNULL(SUM(charge_user), 0) AS chargeUsers,
		IFNULL(SUM(consumer_user), 0) AS consumeUsers
		FROM
		zwsc_base_data b
		<include refid="conditions"></include>
		GROUP BY
		timeCycle
	</select>

    <select id="getChannelUserDataByWeek" resultType="Map">
		SELECT
		    DATE_FORMAT(dt,'%Y-%u') AS timeCycle,
		    IFNULL(SUM(qd_uv), 0) AS qdUsers,
		    IFNULL(SUM(new_user), 0) AS newUsers,
		    IFNULL(SUM(charge_user), 0) AS chargeUsers,
		    IFNULL(SUM(consumer_user), 0) AS consumeUsers
		FROM zwsc_base_data b
		<include refid="conditions"></include>     
		GROUP BY
		    timeCycle  
    </select>
    
    <select id="getChannelUserDataByMonth" resultType="Map">
		SELECT
		    DATE_FORMAT(dt,'%Y-%m') AS timeCycle,
		    IFNULL(SUM(qd_uv), 0) AS qdUsers,
		    IFNULL(SUM(new_user), 0) AS newUsers,
		    IFNULL(SUM(charge_user), 0) AS chargeUsers,
		    IFNULL(SUM(consumer_user), 0) AS consumeUsers
		FROM zwsc_base_data b
		<include refid="conditions"></include>     
		GROUP BY
		    timeCycle  
    </select>
    
    <select id="getSummaryByPage" resultType="Map">
		SELECT
			b.dt AS dt ,
			IFNULL(SUM(b.accumulate_user), 0) AS accumUsers,
			IFNULL(SUM(b.qd_uv), 0) AS qdUsers,
			IFNULL(SUM(b.new_user), 0) AS newUsers,
			IFNULL(SUM(b.qd_pv), 0) AS qdTimes,
			IFNULL(SUM(b.charge_user), 0) AS chargeUsers,
			IFNULL(ROUND(SUM(b.charge_money) /100), 0) AS chargeMoney,
			IFNULL(SUM(b.consumer_user), 0) AS consumeUsers,
			IFNULL(SUM(b.consumer_unitmoney), 0) AS realMoney,
			IFNULL(SUM(b.consumer_unitvirtual), 0) AS copperCoin,
			IFNULL(SUM(b.consumer_cash), 0) AS vouchers,
			IFNULL(
			<if test="cnids == null ">n.book_num</if>
			<if test="cnids != null ">SUM(b.book_num)</if>
			, 0) AS bookNum,
			IFNULL(SUM(b.chapter_pv), 0) AS chapterNum,
			IFNULL(ROUND(a.qd_remain / SUM(b.qd_uv) * 100, 2), 0) AS qdRemain,
			IFNULL(ROUND(a.add_remain / SUM(b.new_user) * 100, 2), 0) AS addRemain,
			IFNULL(SUM(b.consumer_money_user), 0) AS consumerMoneyUser
		FROM
		zwsc_base_data b left join
		(
			select SUM(qd_remain) qd_remain,SUM(add_remain) add_remain,dt
			from qd_add_remain where appname = 'zwsc'
			<if test="startTime != '' and startTime != null">
				AND dt &gt;= #{startTime}
			</if>
			<if test="endTime != '' and endTime != null">
				AND dt &lt;= #{endTime}
			</if>
			<if test="cnids != null and cnids != ''">
				AND cnid IN
				<foreach collection="cnids" item="cnid" open="(" separator="," close=")">
					${cnid}
				</foreach>
			</if>
			GROUP BY dt
		) a on a.dt = b.dt
		LEFT JOIN book_read_num n on n.dt = b.dt and n.appname = 'zwsc'
		<include refid="conditions"></include>
		GROUP BY b.dt
		order by b.dt desc
		<if test="pageSize != 0 ">
			LIMIT #{startRow}, #{pageSize}
		</if>
    </select>
    
    <select id="getSummaryItemCnt" resultType="int">
		SELECT COUNT(1) FROM
		(
			SELECT b.dt
			FROM zwsc_base_data b
			<include refid="conditions"></include>
			GROUP BY dt
		) t
    </select>

	<select id="getZwscBaseDataByChannelAndDate" resultType="cn.advu.workflow.domain.database.ZwscBaseData">
		SELECT dt, IFNULL(SUM(new_user),0) newUser ,IFNULL(SUM(qd_uv),0) qdUV,IFNULL(SUM(charge_money),0) chargeMoney  FROM zwsc_base_data zbd
		WHERE
		zbd.`dt`= #{date1}

		AND cnid =#{cnid} and type=1

	</select>

	<select id="getChannelDetailPageData" resultType="java.util.Map">
		SELECT
		b.cnid,b.dt,
		IFNULL(SUM(b.accumulate_user), 0) AS accumUsers,
		IFNULL(SUM(b.qd_uv), 0) AS qdUsers,
		IFNULL(SUM(b.new_user), 0) AS newUsers,
		IFNULL(SUM(b.qd_pv), 0) AS qdTimes,
		IFNULL(ROUND(SUM(b.charge_money) /100,2), 0) AS chargeMoney,
		IFNULL(SUM(b.charge_user), 0) AS chargeUsers,
		IFNULL(SUM(b.consumer_user), 0) AS consumeUsers,
		IFNULL(SUM(b.consumer_cash), 0) AS vouchers,
		IFNULL(SUM(b.consumer_unitmoney), 0) AS realMoney,
		IFNULL(SUM(b.consumer_unitvirtual), 0) AS copperCoin,
		IFNULL(SUM(b.book_num), 0) AS bookNum,
		IFNULL(SUM(b.chapter_pv), 0) AS chapterNum,
		IFNULL(ROUND(a.qd_remain / SUM(b.qd_uv) * 100,2), 0) AS qdRemain,
		IFNULL(ROUND(a.add_remain / SUM(b.new_user) * 100,2), 0) AS addRemain,
		IFNULL(SUM(b.consumer_money_user), 0) AS consumerMoneyUser
		FROM
		zwsc_base_data b left join
		(
			select SUM(qd_remain) qd_remain,SUM(add_remain) add_remain,cnid,dt
			from qd_add_remain where appname = 'zwsc'
			<if test="startTime != '' and startTime != null">
				AND dt &gt;= #{startTime}
			</if>
			<if test="endTime != '' and endTime != null">
				AND dt &lt;= #{endTime}
			</if>
			<if test="cnids != null and cnids != ''">
				AND cnid IN
				<foreach collection="cnids" item="cnid" open="(" separator="," close=")">
					${cnid}
				</foreach>
			</if>
		GROUP BY cnid,dt
		) a on a.cnid = b.cnid AND a.dt = b.dt
		<where>
			and b.apptype = '1'
			<if test="startTime != '' and startTime != null">
				AND b.dt &gt;= #{startTime}
			</if>

			<if test="endTime != '' and endTime != null">
				AND b.dt &lt;= #{endTime}
			</if>
			<if test="cnids != null and cnids != ''">
				AND b.cnid IN
				<foreach collection="cnids" item="cnid" open="(" separator="," close=")">
					${cnid}
				</foreach>
			</if>
		</where>
		GROUP BY b.cnid,b.dt
		<if test="pageSize != 0">
			LIMIT #{startRow}, #{pageSize}
		</if>
	</select>

	<select id="getChannelDetailPages" resultType="java.lang.Integer">
		SELECT COUNT(1) FROM
		(
			SELECT b.dt
			FROM zwsc_base_data b left join
			(
				select SUM(qd_remain) qd_remain,SUM(add_remain) add_remain,cnid,dt
				from qd_add_remain where appname = 'zwsc'
					<if test="startTime != '' and startTime != null">
						AND dt &gt;= #{startTime}
					</if>
					<if test="endTime != '' and endTime != null">
						AND dt &lt;= #{endTime}
					</if>
					<if test="cnids != null and cnids != ''">
						AND cnid IN
						<foreach collection="cnids" item="cnid" open="(" separator="," close=")">
							${cnid}
						</foreach>
					</if>
					GROUP BY cnid,dt
				) a on a.cnid = b.cnid  AND a.dt = b.dt
				<where>
					and b.apptype = '1'
					<if test="startTime != '' and startTime != null">
						AND b.dt &gt;= #{startTime}
					</if>

					<if test="endTime != '' and endTime != null">
						AND b.dt &lt;= #{endTime}
					</if>
					<if test="cnids != null and cnids != ''">
						AND b.cnid IN
						<foreach collection="cnids" item="cnid" open="(" separator="," close=")">
							${cnid}
						</foreach>
					</if>
				</where>
			GROUP BY b.cnid,b.dt
		) t
	</select>


</mapper>
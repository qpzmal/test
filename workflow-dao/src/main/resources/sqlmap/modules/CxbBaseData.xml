<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.advu.workflow.dao.database.CxbBaseDataMapper">

    <sql id="conditions">
        <where>
            <if test="startTime != '' and startTime != null">
                AND dt &gt;= #{startTime}
            </if>
            <if test="endTime != '' and endTime != null">
                AND dt &lt;= #{endTime}
            </if>
            <if test="cnids != null and cnids != ''">
                AND cnid IN
                <foreach collection="cnids" 
                    item="cnid" open="(" separator="," close=")">
                    ${cnid}
                </foreach>
            </if>
        </where>
    </sql>

    <select id="getVersions" resultType="String">
		SELECT DISTINCT
		    version
		FROM
		    cxb_base_data
		WHERE version IS NOT NULL        
    </select>
    
    <select id="getDetailByPage" resultType="Map">
		SELECT
	        cnid,
	        IFNULL(SUM(accumulate_user), 0) AS accumUsers,
	        IFNULL(SUM(qd_uv), 0) AS qdUsers,
	        IFNULL(SUM(new_user), 0) AS newUsers,
	        IFNULL(SUM(qd_pv), 0) AS qdTimes,
	        IFNULL(SUM(earn_integral), 0) AS earnIntegral,
	        IFNULL(SUM(consumer_integral), 0) AS consumeIntegral,
	        IFNULL(SUM(read_time), 0) AS readTime,
	        IFNULL(SUM(book_num), 0) AS bookNum,
	        IFNULL(SUM(chapter_pv), 0) AS chapterNum,
            IFNULL(ROUND(a.qd_remain / SUM(qd_uv) * 100,2), 0) AS qdRemain,
            IFNULL(ROUND(a.add_remain / SUM(new_user) * 100,2), 0) AS addRemain
		FROM cxb_base_data b left join
        (
        select SUM(qd_remain) qd_remain,SUM(add_remain) add_remain,cnid cid
        from qd_add_remain where appname = 'cxb'
        <if test="startTime != '' and startTime != null">
            AND dt &gt;= #{startTime}
        </if>
        <if test="endTime != '' and endTime != null">
            AND dt &lt;= #{endTime}
        </if>
        <if test="cnids != null and cnids != ''">
            AND cnid IN
            <foreach collection="cnids"
                     item="cnid" open="(" separator="," close=")">
                ${cnid}
            </foreach>
        </if>
        GROUP BY cnid
        ) a on a.cid = b.cnid
		<include refid="conditions"></include>
		GROUP BY cnid
        <if test="pageSize != 0">
            LIMIT #{startRow}, #{pageSize}
        </if>
    </select>
    
    <select id="getItemCnt" resultType="int">
        SELECT COUNT(1) FROM
        (
            SELECT COUNT(1) FROM cxb_base_data
            <include refid="conditions"></include>
            GROUP BY cnid
        ) t
    </select>
    

    <select id="getChannelUserDataByDay" resultType="Map">
        SELECT
            dt AS timeCycle,
            IFNULL(SUM(qd_uv), 0) AS qdUsers,
            IFNULL(SUM(new_user), 0) AS newUsers,
		    IFNULL(SUM(earn_integral), 0) AS earnIntegral,
		    IFNULL(SUM(consumer_integral), 0) AS consumeIntegral
        FROM
            cxb_base_data
        <include refid="conditions"></include>     
        GROUP BY
            timeCycle  
    </select>
    
    <select id="getChannelUserDataByWeek" resultType="Map">
        SELECT
            DATE_FORMAT(dt,'%Y-%u') AS timeCycle,
            IFNULL(SUM(qd_uv), 0) AS qdUsers,
            IFNULL(SUM(new_user), 0) AS newUsers,
            IFNULL(SUM(earn_integral), 0) AS earnIntegral,
            IFNULL(SUM(consumer_integral), 0) AS consumeIntegral
        FROM
            cxb_base_data
        <include refid="conditions"></include>     
        GROUP BY
            timeCycle  
    </select>
    
    <select id="getChannelUserDataByMonth" resultType="Map">
        SELECT
            DATE_FORMAT(dt,'%Y-%m') AS timeCycle,
            IFNULL(SUM(qd_uv), 0) AS qdUsers,
            IFNULL(SUM(new_user), 0) AS newUsers,
            IFNULL(SUM(earn_integral), 0) AS earnIntegral,
            IFNULL(SUM(consumer_integral), 0) AS consumeIntegral
        FROM
            cxb_base_data
        <include refid="conditions"></include>     
        GROUP BY
            timeCycle  
    </select>
    
    <select id="getSummaryByPage" resultType="Map">
        SELECT
            b.dt AS dt,
            IFNULL(SUM(b.accumulate_user), 0) AS accumUsers,
            IFNULL(SUM(b.qd_uv), 0) AS qdUsers,
            IFNULL(SUM(b.new_user), 0) AS newUsers,
            IFNULL(SUM(b.qd_pv), 0) AS qdTimes,
            IFNULL(SUM(b.earn_integral), 0) AS earnIntegral,
            IFNULL(SUM(b.consumer_integral), 0) AS consumeIntegral,
            IFNULL(
            <if test="cnids == null ">n.book_num</if>
            <if test="cnids != null ">SUM(b.book_num)</if>
            , 0) AS bookNum,
            IFNULL(SUM(b.chapter_pv), 0) AS chapterNum,
            IFNULL(SUM(b.read_time), 0) AS readTime,
            IFNULL(ROUND(a.qd_remain / SUM(qd_uv) * 100, 2), 0) AS qdRemain,
            IFNULL(ROUND(a.add_remain / SUM(new_user) * 100, 2), 0) AS addRemain
        FROM cxb_base_data b LEFT JOIN
        (
            select SUM(qd_remain) qd_remain,SUM(add_remain) add_remain,dt date
            from qd_add_remain where appname = 'cxb'
            <if test="startTime != '' and startTime != null">
                AND dt &gt;= #{startTime}
            </if>
            <if test="endTime != '' and endTime != null">
                AND dt &lt;= #{endTime}
            </if>
            <if test="cnids != null and cnids != ''">
                AND cnid IN
                <foreach collection="cnids"
                         item="cnid" open="(" separator="," close=")">
                    ${cnid}
                </foreach>
            </if>
            GROUP BY dt
        ) a on b.dt = a.date
        LEFT JOIN book_read_num n on n.dt = b.dt and appname = 'cxb'
        <where>
            <if test="startTime != '' and startTime != null">
                AND b.dt &gt;= #{startTime}
            </if>
            <if test="endTime != '' and endTime != null">
                AND b.dt &lt;= #{endTime}
            </if>
            <if test="cnids != null and cnids != ''">
                AND b.cnid IN
                <foreach collection="cnids"
                         item="cnid" open="(" separator="," close=")">
                    ${cnid}
                </foreach>
            </if>
        </where>
        GROUP BY dt
        ORDER BY dt DESC
        <if test="pageSize != 0">
            LIMIT #{startRow}, #{pageSize}
        </if>
    </select>
    
    <select id="getSummaryItemCnt" resultType="int">
        SELECT COUNT(1) FROM
        (
          SELECT dt FROM cxb_base_data
          <include refid="conditions"></include>
          GROUP BY dt
        ) t
    </select>
</mapper>
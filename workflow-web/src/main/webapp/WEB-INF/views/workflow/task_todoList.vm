

#define($cssblock)
<link href="#springUrl("")/static/css/plugins/jquery-qtip/jquery.qtip.min.css?$!application.getAttribute('/static/css/plugins/jquery-qtip/jquery.qtip.min.css')" rel="stylesheet">
<link href="#springUrl("")/static/css/plugins/jquery-ui/jquery-ui.min.css?$!application.getAttribute('/static/css/plugins/jquery-ui/jquery-ui.min.css')" rel="stylesheet">
#end

<div class="wrapper wrapper-content">
    <div class="row">
        <div class="col-sm-12">

            ## 采购单
            #foreach($dataForName in ${baseBuyOrderVOList})
                #if($!{velocityCount} == 2) #break #end
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>$!{dataForName.processInstance.processDefinitionName}</h5>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                    <tr>
                                        <th>审批流程名称</th>
                                        <th>申请人</th>
                                        <th>当前节点</th>
                                        <th>任务创建时间</th>
                                        <th>流程版本状态</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        #foreach($!{data} in $!{baseBuyOrderVOList})
                                        <tr id="$!{data.baseBuyOrder.id}" tid="$!{data.task.id}" pkey="$!data.processInstance.ProcessDefinitionKey" pid="$!{data.processInstance.id}">
                                            <td>$!{data.baseBuyOrder.name}</td>
                                            <td>$!{data.baseBuyOrder.userName}</td>
                                            <td>
                                                <a class="trace" href='javascript:;' pid="$!{data.processInstance.id}" pdid="${data.processInstance.processDefinitionId}" title="点击查看流程图">$!{data.task.name}</a>
                                            </td>
                                        ##                                <td><a target="_blank" href='${ctx}/workflow/resource/process-instance?pid=${data.processInstance.id}&type=xml'>${data.task.name}</a></td>
                                            <td>$!date.format('yyyy-MM-dd HH:mm:ss ',${data.task.createTime})</td>
                                            <td>
                                            ##                                    ${pi.suspended ? "已挂起" : "正常" }；
                                                <b title='流程版本号'>V: $!{data.processDefinition.version}</b>
                                            </td>
                                            <td>
                                                #if(!${data.task.assignee})
                                                    <a href="javascript:;" class="btn btn-info btn-sm button_to_start btn_claim"><i class="fa fa-play "></i> 签收 </a>
                                                #end
                                                #if(${data.task.assignee})
                                                ##  此处用tkey记录当前节点的名称
                                                    #if($data.isModify == true) ## 流程发起人调整流程
                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_handle_modify" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-play "></i> 处理申请</a>

                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_edit" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-pencil "></i> 调整申请</a>
                                                    #else
                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_handle" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-play "></i> 办理</a>
                                                    #end
                                                #end

                                                <a href="javascript:;" class="btn btn-default btn-sm button_view"><i class="fa fa-search "></i> 查看 </a>
                                            </td>
                                        </tr>
                                        #end
                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>
            #end

            ## 框架采购单
            #foreach($dataForName in ${baseBuyOrderFrameVOList})
                #if($!{velocityCount} == 2) #break #end
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>$!{dataForName.processInstance.processDefinitionName}</h5>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                    <tr>
                                        <th>审批流程名称</th>
                                        <th>申请人</th>
                                        <th>当前节点</th>
                                        <th>任务创建时间</th>
                                        <th>流程版本状态</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        #foreach($!{data} in $!{baseBuyOrderFrameVOList})
                                        <tr id="$!{data.baseBuyOrderFrame.id}" tid="$!{data.task.id}" pkey="$!data.processInstance.ProcessDefinitionKey" pid="$!{data.processInstance.id}">
                                            <td>$!{data.baseBuyOrderFrame.name}</td>
                                            <td>$!{data.baseBuyOrderFrame.userName}</td>
                                            <td>
                                                <a class="trace" href='javascript:;' pid="$!{data.processInstance.id}" pdid="${data.processInstance.processDefinitionId}" title="点击查看流程图">$!{data.task.name}</a>
                                            </td>
                                        ##                                <td><a target="_blank" href='${ctx}/workflow/resource/process-instance?pid=${data.processInstance.id}&type=xml'>${data.task.name}</a></td>
                                            <td>$!date.format('yyyy-MM-dd HH:mm:ss ',${data.task.createTime})</td>
                                            <td>
                                            ##                                    ${pi.suspended ? "已挂起" : "正常" }；
                                                <b title='流程版本号'>V: $!{data.processDefinition.version}</b>
                                            </td>
                                            <td>
                                                #if(!${data.task.assignee})
                                                    <a href="javascript:;" class="btn btn-info btn-sm button_to_start btn_claim"><i class="fa fa-play "></i> 签收 </a>
                                                #end
                                                #if(${data.task.assignee})
                                                ##  此处用tkey记录当前节点的名称
                                                    #if($data.isModify == true) ## 流程发起人调整流程
                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_handle_modify" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-play "></i> 处理申请</a>

                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_edit" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-pencil "></i> 调整申请</a>
                                                    #else
                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_handle" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-play "></i> 办理</a>
                                                    #end
                                                #end

                                                <a href="javascript:;" class="btn btn-default btn-sm button_view"><i class="fa fa-search "></i> 查看 </a>
                                            </td>
                                        </tr>
                                        #end
                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>
            #end

            ## 需求单
            #foreach($dataForName in ${baseExecuteOrderVOList})
                #if($!{velocityCount} == 2) #break #end
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>$!{dataForName.processInstance.processDefinitionName}</h5>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                    <tr>
                                        <th>审批流程名称</th>
                                        <th>申请人</th>
                                        <th>当前节点</th>
                                        <th>任务创建时间</th>
                                        <th>流程版本状态</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        #foreach($!{data} in $!{baseExecuteOrderVOList})
                                        <tr id="$!{data.baseExecuteOrder.id}" tid="$!{data.task.id}" pkey="$!data.processInstance.ProcessDefinitionKey" pid="$!{data.processInstance.id}">
                                            <td>$!{data.baseExecuteOrder.name}</td>
                                            <td>$!{data.baseExecuteOrder.userName}</td>
                                            <td>
                                                <a class="trace" href='javascript:;' pid="$!{data.processInstance.id}" pdid="${data.processInstance.processDefinitionId}" title="点击查看流程图">$!{data.task.name}</a>
                                            </td>
                                        ##                                <td><a target="_blank" href='${ctx}/workflow/resource/process-instance?pid=${data.processInstance.id}&type=xml'>${data.task.name}</a></td>
                                            <td>$!date.format('yyyy-MM-dd HH:mm:ss ',${data.task.createTime})</td>
                                            <td>
                                            ##                                    ${pi.suspended ? "已挂起" : "正常" }；
                                                <b title='流程版本号'>V: $!{data.processDefinition.version}</b>
                                            </td>
                                            <td>
                                                #if(!${data.task.assignee})
                                                    <a href="javascript:;" class="btn btn-info btn-sm button_to_start btn_claim"><i class="fa fa-play "></i> 签收 </a>
                                                #end
                                                #if(${data.task.assignee})
                                                ##  此处用tkey记录当前节点的名称
                                                    #if($data.isModify == true) ## 流程发起人调整流程
                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_handle_modify" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-play "></i> 处理申请</a>

                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_edit" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-pencil "></i> 调整申请</a>
                                                    #else
                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_handle" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-play "></i> 办理</a>
                                                    #end
                                                #end

                                                <a href="javascript:;" class="btn btn-default btn-sm button_view"><i class="fa fa-search "></i> 查看 </a>
                                            </td>
                                        </tr>
                                        #end
                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>
            #end

            ## 框架需求单
            #foreach($dataForName in ${baseExecuteOrderFrameVOList})
                #if($!{velocityCount} == 2) #break #end
                <div class="row">
                    <div class="col-sm-12">
                        <div class="ibox float-e-margins">
                            <div class="ibox-title">
                                <h5>$!{dataForName.processInstance.processDefinitionName}</h5>
                            </div>
                            <div class="ibox-content">
                                <table class="table table-bordered table-striped">
                                    <thead>
                                    <tr>
                                        <th>审批流程名称</th>
                                        <th>申请人</th>
                                        <th>当前节点</th>
                                        <th>任务创建时间</th>
                                        <th>流程版本状态</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                        #foreach($!{data} in $!{baseExecuteOrderFrameVOList})
                                        <tr id="$!{data.baseExecuteOrderFrame.id}" tid="$!{data.task.id}" pkey="$!data.processInstance.ProcessDefinitionKey" pid="$!{data.processInstance.id}">
                                            <td>$!{data.baseExecuteOrderFrame.name}</td>
                                            <td>$!{data.baseExecuteOrderFrame.userName}</td>
                                            <td>
                                                <a class="trace" href='javascript:;' pid="$!{data.processInstance.id}" pdid="${data.processInstance.processDefinitionId}" title="点击查看流程图">$!{data.task.name}</a>
                                            </td>
                                        ##                                <td><a target="_blank" href='${ctx}/workflow/resource/process-instance?pid=${data.processInstance.id}&type=xml'>${data.task.name}</a></td>
                                            <td>$!date.format('yyyy-MM-dd HH:mm:ss ',${data.task.createTime})</td>
                                            <td>
                                            ##                                    ${pi.suspended ? "已挂起" : "正常" }；
                                                <b title='流程版本号'>V: $!{data.processDefinition.version}</b>
                                            </td>
                                            <td>
                                                #if(!${data.task.assignee})
                                                    <a href="javascript:;" class="btn btn-info btn-sm button_to_start btn_claim"><i class="fa fa-play "></i> 签收 </a>
                                                #end
                                                #if(${data.task.assignee})
                                                ##  此处用tkey记录当前节点的名称
                                                    #if($data.isModify == true) ## 流程发起人调整流程
                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_handle_modify" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-play "></i> 处理申请</a>

                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_edit" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-pencil "></i> 调整申请</a>
                                                    #else
                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_handle" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-play "></i> 办理</a>
                                                    #end
                                                #end

                                                <a href="javascript:;" class="btn btn-default btn-sm button_view"><i class="fa fa-search "></i> 查看 </a>
                                            </td>
                                        </tr>
                                        #end
                                    </tbody>
                                </table>

                            </div>
                        </div>
                    </div>
                </div>
            #end



            ## 排期执行单
                #foreach($dataForName in ${baseExecuteOrderExecuteVOList})
                    #if($!{velocityCount} == 2) #break #end
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <h5>$!{dataForName.processInstance.processDefinitionName}</h5>
                                </div>
                                <div class="ibox-content">
                                    <table class="table table-bordered table-striped">
                                        <thead>
                                        <tr>
                                            <th>审批流程名称</th>
                                            <th>申请人</th>
                                            <th>当前节点</th>
                                            <th>任务创建时间</th>
                                            <th>流程版本状态</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                            #foreach($!{data} in $!{baseExecuteOrderExecuteVOList})
                                            <tr id="$!{data.baseExecuteOrder.id}" tid="$!{data.task.id}" pkey="$!data.processInstance.ProcessDefinitionKey" pid="$!{data.processInstance.id}">
                                                <td>$!{data.baseExecuteOrder.name}</td>
                                                <td>$!{data.baseExecuteOrder.userName}</td>
                                                <td>
                                                    <a class="trace" href='javascript:;' pid="$!{data.processInstance.id}" pdid="${data.processInstance.processDefinitionId}" title="点击查看流程图">$!{data.task.name}</a>
                                                </td>
                                            ##                                <td><a target="_blank" href='${ctx}/workflow/resource/process-instance?pid=${data.processInstance.id}&type=xml'>${data.task.name}</a></td>
                                                <td>$!date.format('yyyy-MM-dd HH:mm:ss ',${data.task.createTime})</td>
                                                <td>
                                                ##                                    ${pi.suspended ? "已挂起" : "正常" }；
                                                    <b title='流程版本号'>V: $!{data.processDefinition.version}</b>
                                                </td>
                                                <td>
                                                    #if(!${data.task.assignee})
                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_claim"><i class="fa fa-play "></i> 签收 </a>
                                                    #end
                                                    #if(${data.task.assignee})
                                                        ##  此处用tkey记录当前节点的名称
                                                        #if($data.isModify == true) ## 流程发起人调整流程
                                                            <a href="javascript:;" class="btn btn-info btn-sm btn_handle_modify" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-play "></i> 处理申请</a>

                                                        #else
                                                            <a href="javascript:;" class="btn btn-info btn-sm btn_handle" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-play "></i> 办理</a>
                                                        #end

                                                        <a href="javascript:;" class="btn btn-info btn-sm btn_edit" tkey='$!{data.task.taskDefinitionKey}' tname='$!{data.task.name}'><i class="fa fa-pencil "></i> 调整申请</a>
                                                    #end

                                                    <a href="javascript:;" class="btn btn-default btn-sm button_view"><i class="fa fa-search "></i> 查看 </a>
                                                </td>
                                            </tr>
                                            #end
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>
                    </div>
                #end

        </div>
    </div>
</div>


## 审批用窗口
<div class="ibox-content task-audit" style="display:none">
    <form class="form-horizontal m-t" id="commentForm" action="">
        <div class="form-group">
            <label class="col-sm-3 control-label">
                *驳回原因:
            </label>
            <div class="col-sm-8">
##                <input id="reason" name="reason" placeholder="驳回原因" type="text" class="form-control" rows="6">
                <textarea class="form-control"  id="reason" name="reason" placeholder="驳回原因"  rows="3"></textarea>
            </div>
        </div>

        <div class="form-group">
            <div class="col-sm-3 col-sm-offset-1">
                <button class="btn btn-primary agree-apply" type="button"><i class="fa fa-check"></i> 同意</button>
            </div>
            <div class="col-sm-3 col-sm-offset-1">
                <button class="btn btn-danger reject-apply" type="button"><i class="fa fa-remove"></i> 驳回</button>
            </div>
        </div>
    </form>
</div>




## 申请人调整申请用窗口
<div class="ibox-content task-modify" style="display:none">
</div>





#define($jsblock)
<script type="text/javascript" src="#springUrl("")/static/js/plugins/jquery-ui/jquery-ui.min.js?$!application.getAttribute('/static/js/plugins/jquery-ui/jquery-ui.min.js')"></script>
<script type="text/javascript" src="#springUrl("")/static/js/modules/activiti/workflow.js?$!application.getAttribute('/static/js/modules/activiti/workflow.js')"></script>
<script type="text/javascript" src="#springUrl("")/static/js/plugins/jquery-qtip/jquery.qtip.min.js?$!application.getAttribute('/static/js/plugins/jquery-qtip/jquery.qtip.min.js')"></script>
<script type="text/javascript" src="#springUrl("")/static/js/plugins/jquery-outerhtml/jquery.outerhtml.js?$!application.getAttribute('/static/js/plugins/jquery-outerhtml/jquery.outerhtml.js')"></script>
<script src="#springUrl("")/static/js/plugins/layer/laydate/laydate.js?$!application.getAttribute('/static/js/plugins/layer/laydate/laydate.js')" type="text/javascript" language="javascript"></script>

<script>
    var taskId;
    var pkey;
    var tkey;
    var pid;
    var bizId;
    $(function(){
//        init();
    });


    // 跟踪
    $('.trace').click(graphTrace);

    ## 签收（示例：弹出确认框）
    $(".btn_claim").click(function(){
        var taskId = $(this).parents('tr').attr('tid');

        layer.confirm('确认签收？', {
            title: '确认',
            btn: ['确认','取消'] //按钮
        }, function(){
            window.location.href = "/workflow/task/claim/" + taskId;
        }, function(){
        });
    })

    ## 打开[办理]页面
    $(".btn_handle").click(function(){
        taskId = $(this).parents('tr').attr('tid');
        pkey = $(this).parents('tr').attr('pkey');
        pid = $(this).parents('tr').attr('pid');
        bizId = $(this).parents('tr').attr('id');
        tkey = $(this).attr('tkey');
//        var url = '/workflow/task/toAudit?pkey=' + pkey + '&tkey='+tkey + '&taskId='+taskId;
        openPopDivPage_taskAudit();
    })

    ## 打开[申请人调整申请用窗口]页面
    $(".btn_handle_modify").click(function(){
        taskId = $(this).parents('tr').attr('tid');
        pkey = $(this).parents('tr').attr('pkey');
        pid = $(this).parents('tr').attr('pid');
        bizId = $(this).parents('tr').attr('id');
        tkey = $(this).attr('tkey');
//        var url = '/workflow/task/toAudit?pkey=' + pkey + '&tkey='+tkey + '&taskId='+taskId;
        openPopDivPage_taskModify();
    })

    ## 查看
    $(".button_view").click(function(){
        var taskId = $(this).parents('tr').attr('id'); // 取申请ID
        var pkey = $(this).parents('tr').attr('pkey');
        if (pkey == "saleExecute") {
            pkey ="saleOrder";
        }
        var url = "${rc.contextPath}/"+ pkey+"/refer?id="+taskId;
        openPopIframePage(url);
    })

    ## 修改
    $(".btn_edit").click(function(){
        var taskId = $(this).parents('tr').attr('id'); // 取申请ID
        var pkey = $(this).parents('tr').attr('pkey');
        var url = "${rc.contextPath}/saleOrder/toUpdate?id="+taskId;
        openPopIframePage(url);
    })

    ## 查看（示例：弹出Iframe窗口）
    function openPopIframePage(url){
        layer.open({
            type: 2,
            title: '确认',
            shadeClose: true,
            shade: false,
            maxmin: true, //开启最大化最小化按钮
            area: ['893px', '500px'],
            content: url
        });
    }

    ## 办理（示例：弹出确认页）
    function openPopDivPage_taskAudit(){
        layer.open({
            type: 1,
            title: false, //不显示标题
            skin: 'layui-layer-rim', //加上边框
            area: ['600px', '240px'], //宽高
//            closeBtn: 0, //不显示关闭按钮
            shadeClose: true, //开启遮罩关闭
            content: $('.task-audit'),
        });
    }


    ## 办理（示例：弹出确认页）
    function openPopDivPage_taskModify(){
        var url = "/workflow/task/toReApply";
        $.ajax({
            url:url,
            type:"post",
            data:{
                "taskId":taskId
            },
            success: function(returnData){
                $(".task-modify").html(returnData);
            }
        });
        layer.open({
            type: 1,
            title: false, //不显示标题
            skin: 'layui-layer-rim', //加上边框
            area: ['600px', '240px'], //宽高
//            closeBtn: 0, //不显示关闭按钮
            shadeClose: true, //开启遮罩关闭
            content: $('.task-modify'),
        });
    }

    ## 同意
    $(".agree-apply").click(function(){
        complete(true);
    })

    ## 驳回
    $(".reject-apply").click(function(){
        if ($.trim($('#reason').val()) == '') {
            layer.msg('请填写驳回原因');
            return;
        }

        complete(false);
    })


    ## 重新申请
    $(".task-modify").on("click", ".re-apply", function(){

        layer.confirm('请确定您已经调整过申请了', {
            title: '重新申请',
            btn: ['确认','取消'] //按钮
        }, function(){
            complete(true);
        }, function(){
        });

    })
    ## 终止申请
    $(".task-modify").on("click", ".channel-apply", function(){

        layer.confirm('此申请即将终止，如需申请请再次提交申请单', {
            title: '取消申请',
            btn: ['确认','取消'] //按钮
        }, function(){
            complete(false);
        }, function(){
        });
    })


    // 添加
    function complete(result){
        var url = '/workflow/task/complete.json';
        $.ajax({
            url:url,
            type:"post",
            data:{
                "pkey":pkey,
                "tkey":tkey,
                "pid":pid,
                "bizId":bizId,
                "taskId":taskId,
                "result":result,
                "reason":$.trim($('#reason').val())
            },
            success: function(returnData){
                if(returnData.code == 1){
                    layer.msg('审批完成');

                    setTimeout(function(){
                        window.location.href = "${rc.contextPath}/workflow/task/todo";
                        }, 300
                    );
                } else{
                    layer.msg('操作失败, 请联系技术人员!');
                }
            }
        });
    }

</script>
#end